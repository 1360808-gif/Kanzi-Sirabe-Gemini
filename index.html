<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãµã‚ŠãŒãªï¼†æ¼¢å­—ãƒã‚¸ãƒƒã‚¯ï¼</title>
    <script src="https://unpkg.com/wanakana"></script>
    <style>
        body {
            font-family: "UD Digi Kyokasho N-R", sans-serif;
            background-color: #fcfcfc; margin: 0; display: flex; flex-direction: column; height: 100vh; color: #333;
        }
        header { flex: 0 0 auto; display: flex; padding: 15px 20px; gap: 20px; background-color: #eef9ff; border-bottom: 2px solid #a6dcef; }
        .info-pane { flex: 1; }
        h1 { color: #1a73e8; margin: 0 0 5px 0; font-size: 1.2rem; }
        .input-pane { flex: 2; }
        textarea { width: 100%; height: 80px; border: 2px solid #a6dcef; border-radius: 12px; padding: 10px; font-size: 16px; resize: none; outline: none; }
        
        main { flex: 1; padding: 20px; overflow-y: auto; background: white; }
        #output { font-size: 24px; line-height: 2.5; }
        
        /* å€™è£œãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .suggestion-box {
            display: inline-block;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            margin: 5px;
            padding: 5px 10px;
            font-size: 14px;
            line-height: 1.2;
            vertical-align: middle;
        }
        .suggestion-item {
            color: #856404;
            cursor: pointer;
            text-decoration: underline;
            margin-right: 8px;
        }
        .suggestion-item:hover { color: #e67e22; }

        rt { color: #d9534f; font-size: 0.5em; font-weight: bold; }
        .btn { background: #ff9f43; color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div class="info-pane">
        <h1>âœ¨ ãµã‚ŠãŒãªï¼†æ¼¢å­—ãƒã‚¸ãƒƒã‚¯</h1>
        <div style="font-size: 0.8rem;">ã²ã‚‰ãŒãªâ†’æ¼¢å­—å€™è£œ / æ¼¢å­—â†’ãƒ•ãƒªã‚¬ãƒŠï¼†åŒã˜éŸ³ã®æ¼¢å­—</div>
    </div>
    <div class="input-pane">
        <textarea id="input" placeholder="ã“ã“ã«æ–‡å­—ã‚’ã†ã£ã¦ã­ï¼"></textarea>
    </div>
</header>

<main>
    <div id="output"></div>
</main>

<script>
    const input = document.getElementById('input');
    const output = document.getElementById('output');
    let timer;

    input.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(processMagic, 800);
    });

    async function processMagic() {
        const text = input.value.trim();
        if (!text) { output.innerHTML = ""; return; }

        const segmenter = new Intl.Segmenter('ja-JP', { granularity: 'word' });
        const segments = Array.from(segmenter.segment(text));
        
        output.innerHTML = "ğŸª„ ã¾ã»ã†ã‚’ ã‹ã‘ã¦ã„ã¾ã™...";
        let htmlResult = "";

        for (const seg of segments) {
            const word = seg.segment;

            // â‘  æ¼¢å­—ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼šãƒ•ãƒªã‚¬ãƒŠï¼‹åŒéŸ³ç•°ç¾©èª
            if (/[\u4E00-\u9FFF]/.test(word)) {
                const reading = await getReading(word);
                const suggestions = await getKanjiCandidates(reading);
                
                htmlResult += `<ruby>${word}<rt>${reading}</rt></ruby>`;
                htmlResult += `<span class="suggestion-box">ğŸ”åŒã˜éŸ³: ${suggestions}</span> `;
            } 
            // â‘¡ ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã®ã¿ã®å ´åˆï¼šæ¼¢å­—å€™è£œã‚’å‡ºã™
            else if (/^[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼]+$/.test(word) && word.length > 1) {
                const candidates = await getKanjiCandidates(word);
                htmlResult += `<span>${word}</span>`;
                htmlResult += `<span class="suggestion-box">ğŸ“æ¼¢å­—ãªã‚‰: ${candidates}</span> `;
            } 
            else {
                htmlResult += word;
            }
        }
        output.innerHTML = htmlResult;
    }

    // Googleç¿»è¨³APIã‚’åˆ©ç”¨ã—ãŸèª­ã¿å–ã‚Šï¼ˆå‰å›ã®ã‚³ãƒ¼ãƒ‰ã®æ”¹è‰¯ç‰ˆï¼‰
    async function getReading(word) {
        try {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=ja&dt=rm&q=${encodeURIComponent(word)}`;
            const response = await fetch(url);
            const data = await response.json();
            let romaji = (data[0] && data[0][0] && data[0][0][3]) ? data[0][0][3] : "";
            let fixed = romaji.toLowerCase().replace(/[ÄÄ«Å«Ä“Å]/g, m => ({'Ä':'aa','Ä«':'ii','Å«':'uu','Ä“':'ee','Å':'ou'}[m]));
            return wanakana.toHiragana(fixed.replace(/[^a-z]/g, ''));
        } catch { return "???"; }
    }

    // Googleå…¥åŠ›ãƒ„ãƒ¼ãƒ«APIã‚’åˆ©ç”¨ã—ãŸæ¼¢å­—å€™è£œã®å–å¾—
    async function getKanjiCandidates(kana) {
        try {
            const url = `https://www.google.com/inputtools/request?ime=transliteration-en-ja&num=5&cp=0&cs=0&ie=utf-8&oe=utf-8&app=jsapi&text=${encodeURIComponent(kana)}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data[0] === "SUCCESS") {
                const candidates = data[1][0][1];
                // å¤‰æ›å€™è£œã‚’ãƒªãƒ³ã‚¯å½¢å¼ã«ã™ã‚‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›æ¬„ã¸ï¼‰
                return candidates.slice(0, 5).map(c => `<span class="suggestion-item" onclick="replaceInput('${c}')">${c}</span>`).join('');
            }
            return "ãªã—";
        } catch { return "æ¤œç´¢å¤±æ•—"; }
    }

    // å€™è£œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰å…¥åŠ›æ¬„ã«è¿½åŠ ï¼ˆãŠã¾ã‘æ©Ÿèƒ½ï¼‰
    window.replaceInput = (val) => {
        input.value += val;
        processMagic();
    };
</script>
</body>
</html>
