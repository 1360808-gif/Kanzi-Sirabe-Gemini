/* --- getReading関数を以下のように書き換えています --- */

// 1. 特殊な読み方の辞書を作成
const CUSTOM_READINGS = {
    "鬱": "うつ",
    "𰻞": "ビャン",
    "𰻞𰻞麺": "ビャンビャンメン",
    "薔薇": "ばら",
    "醤油": "しょうゆ",
    "味噌": "みそ"
};

async function getReading(text) {
    // まず辞書にあるかチェック
    if (CUSTOM_READINGS[text]) {
        return CUSTOM_READINGS[text];
    }

    // 辞書になければAPIで取得
    try {
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=ja&dt=rm&q=${encodeURIComponent(text)}`;
        const res = await fetch(url);
        const data = await res.json();
        
        let romaji = (data[0] && data[0][0] && data[0][0][3]) ? data[0][0][3] : "";
        
        // ピンイン特有の記号（āなど）が混じった場合の対策も兼ねて、
        // 辞書にない未知の難読漢字はそのまま返すか、特定の処理を挟む
        let fixed = romaji.toLowerCase().replace(/[~~\-ー\s]/g, '');
        const romajiMap = { 'ā': 'aa', 'ī': 'ii', 'ū': 'uu', 'ē': 'ei', 'ō': 'ou' };
        Object.keys(romajiMap).forEach(key => { fixed = fixed.split(key).join(romajiMap[key]); });
        
        return wanakana.toHiragana(fixed);
    } catch (e) { return text; }
}
